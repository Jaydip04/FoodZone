require(["ta/rollupAmdShim"],function(a){a.install(["ta/photos/sponsoredVideo"],["ta"])});if(window.requirejs&&requirejs.taConfig){requirejs.taConfig({deferred:{},name:"photo_album_sponsored_video",files:{js3:{src:{ta:{photos:{sponsoredVideo:1}}}}},_:{baseUrl:"/"}})};define("ta/photos/sponsoredVideo",["ta","lib/jquery-amd","utils/ajax","ta/util/Error","ta/Core/TA.Store","ta/Core/TA.Event","ta/Core/TA.Record","ta/Core/TA.LocalStorage","ta/projects","utils/flash","utils/resourceLoader","ns-exporter"],function(ao,az,aE,r,F,aG,an,aJ,v,ax,ay,aq){var am=null,ap=false,ab=az(document.body).hasClass("rtl"),o=false,D=2,H=false,u=91472856971,E="gpt-ad-4x4-a-locationphotoalbum",K="gpt-ad-300x250-locationphotoalbum",ae=false,w=false,aQ=null,ar="play",f=0,j=false,X=3,P=2,aw=1.77,p=parseInt((window.locId||window.modelGeoId),10),m=F.retrieve("sponsoredVideo.localize.sponsoredBy"),aC=F.retrieve("sponsoredVideo.localize.skipAd"),N=F.retrieve("sponsoredVideo.localize.skipAdIn3Secs"),W=F.retrieve("sponsoredVideo.localize.enableAudio"),y=F.retrieve("sponsoredVideo.localize.nowPlaying"),ad=0,Y=0,O=[5,20],aa=[4,19],aT="47%",au="SPONSORED_VIDEO",aA="JWPLAYER_SPONSORED_VIDEO",d=".jw-media",aB=".jw-media",aI="#LOC_PHOTO_ALBUMS .photoRegion",J="#LOC_PHOTO_ALBUMS .mainImg, #meta_on_photo_viewer, #LOC_PHOTO_ALBUMS .heroPhoto a.heroNav,#LOC_PHOTO_ALBUMS .bottomBar, #LOC_PHOTO_ALBUMS .reviewWrapperOverlay",aD=".heroNav.right.showOnHover, .heroNav.left.showOnHover, .heroThumbnails.showOnHover",aP=".photoRegion .heroNav.right",V=(window.MEDIA_HTTP_BASE||"http://media-cdn.tripadvisor.com/media/")+"solutions/wrapperVideo",aS=[".mp4",".flv"],aM=(window.CDNHOST||"")+"/img2/photolb/sponsored_video_thumb.jpg",ac=126862529,R=50,I=15,aR=35,ak=40,S=null,U=null,aN=100,L=250,av=300,l=function(){var aW=false;try{var aU=az(aI);if(!w&&p&&aU.is(":visible")){aW=true}}catch(aV){}return aW},z=function(aW,aU,aV,aX){var aY=(S)?S:0;an.trackEventOnPage("pa_spr_vid",aW,aU,aY,aX)},aL=function(){var aU=500;return(aQ)?Math.floor((new Date().getTime()-aQ)/aU)*aU:0},n=function(){var aW={h:345,w:Math.floor(345*aw),t:"10%"};var aV=az(aP);var aX=az("#LOC_PHOTO_ALBUMS .heroThumbnails");var a0=az(aI);if(a0.length){try{var aU=aV.outerHeight()*2;var aY=aX.outerHeight();var aZ=a0.outerHeight()-aY;var a2=a0.outerWidth()-aU;if(a2/aZ>=aw){aW.h=aZ;aW.w=Math.floor(aZ*aw)}else{aW.h=Math.floor(a2/aw);aW.w=a2}aW.t=Math.floor((aZ-aW.h)/2)}catch(a1){r.record(a1,"sponsored video: unable to determine optimal player size returning default")}}return aW},h=function(aV){aV.toggleClass("audioOn");am.getPlayer().setMute(!aV.hasClass("audioOn"));var aU=aV.hasClass("audioOn")?"tog_on":"tog_off";z("audio",aU,aL(),false);aV.hide()},t=function(){var a1=az("#"+au);if(a1.length){var aX=az("#LOC_PHOTO_ALBUMS .heroThumbnails");var aY=aX.length?Math.floor(aX.outerHeight()/2):0;var a2=ad>0?Math.floor(ad/2):0;var aZ=(aY+a2>0)?(aY+a2)*-1:0;var aW="heroNav showOnHover hidden";var a3={marginTop:aZ+"px"};var a0=az('<span class="right"></span>').addClass(aW).css(a3).click(Q);var aU=az('<span class="left"></span>').addClass(aW).css(a3).click(Q);if(v.isTabletAlbumViewer()){var aV=az('<span class="svgico icon"></span>').appendTo(a0);aV.cloneNode(true).appendTo(aU)}a1.append(a0,aU)}},k=function(){var aW=az("#LOC_PHOTO_ALBUMS .heroThumbnails");var aV=az("#"+au);if(aV.length&&aW.length){var aU=aW.outerHeight();az('<div class="tmbListener"></div>').css({height:aU+"px"}).click(aO).appendTo(aV)}else{r.record(null,"sponsored video: unable to create faux thumbnail layer")}},q=function(aU){var aX=az("#SPONSORED_VIDEO .skipSecs");var aV=az("#SPONSORED_VIDEO .skipNow");if(aX.length&&aV.length){if(!aU){aU=j?0:X}if(aU<X){aU++;var aW=aX.children(".cntDwn");aW.html(X+1-aU);setTimeout(function(){q(aU)},1000)}else{aX.hide();aV.show();t();k();az("#"+au).addClass("transparent")}}},aF=function(aV){for(var aU in aV){var aW=aV[aU];for(var aX in aW){aW[aX]+="px"}}return aV},aH=function(){var a1=az('<span class="sprVidMsg skipSecs"></span>').text(N);var a5=aC+"&nbsp;<em>&rsaquo;</em>";var a0=az('<span class="sprVidMsg skipNow"></span>').html(a5).click(B);var aU=az('<div class="sprVidLayer sprVidSkip"></div>').append(a1,a0);var aV=az('<span class="sprVidLabel sprVidLogo"></span>');var a4="&thinsp;"+m+"&thinsp;";az("<span></span>").html(a4).appendTo(aV);var aX=a();if(aX){az("<img>").prop("src",aX).appendTo(aV)}var a2=null;var aW=null;if(F.retrieve("sponsoredVideo.videoTitle")){var aZ=M();if(aZ){aW=az('<span class="sprVidTitle"></span>');az('<div class="nowPlaying"></div>').text(y).appendTo(aW);az('<div class="videoTitle"></div>').text(aZ).appendTo(aW);a2=az('<div class="sprVidGradient"></div>')}}var aY=Z();if(aY&&aY.skipAdPosition){aU.css(aY.skipAdPosition)}if(aY&&aY.logoPosition){aV.css(aY.logoPosition)}if(aY&&aY.titlePosition&&aW){aW.css(aY.titlePosition)}if(aY&&aY.gradientPosition&&a2){a2.css(aY.gradientPosition)}var a3=az("#"+au);if(a3.length){a3.append(aU,aV);if(aW&&a2){a3.append(a2,aW);setTimeout(function(){a3.addClass("noTitle")},5000)}}},Z=function(){var aY=az("#"+au);var aU=az(d)||az(aB);if(aY.length&&aU.length){var aX=0;var aZ=0;var aW=aU.offset().top-aY.offset().top;if(aU.height()+aW<=aY.height()){aX=aY.height()-aW-aU.height()}if(aY.width()>aU.width()){aZ=Math.floor((aY.width()-aU.width())/2)}var aV={skipAdPosition:{bottom:aX+R},logoPosition:{top:aW+I},titlePosition:{top:aW+ak},gradientPosition:{top:aW,bottom:aX,left:aZ,right:aZ}};if(ab){aV.skipAdPosition.left=aZ;aV.logoPosition.left=aZ+I;aV.titlePosition.right=aZ+aR;aV.titlePosition.left=aV.titlePosition.right}else{aV.skipAdPosition.right=aZ;aV.logoPosition.right=aZ+I;aV.titlePosition.left=aZ+aR;aV.titlePosition.right=aV.titlePosition.left}return aF(aV)}return null},A=function(){var a0="#"+au;var aU=az(a0+" .sprVidLabel.sprVidLogo");var aY=az(a0+" .sprVidLayer.sprVidSkip");var aW=az(a0+" .sprVidTitle");var aZ=az(a0+" .sprVidGradient");var a2=az(a0+" .videoPlayer");var a1=az(".sprVidLayer.sprVidAudio");var aV=n();if(v.isTabletAlbumViewer()){a1.css("top",aT);a2.css("top",aV.t+"px")}var aX=Z();if(aX){if(aX.skipAdPosition){aY.css(aX.skipAdPosition)}if(aX.logoPosition){aU.css(aX.logoPosition)}if(aX.titlePosition){aW.css(aX.titlePosition)}if(aX.gradientPosition){aZ.css(aX.gradientPosition)}}},aj=function(){return"video"+f},x=function(aZ){S=null;if(aZ&&aZ.companions&&aZ.companions.length){try{var aV=new RegExp(/ta_cid\=(\d+)/);var aX=new RegExp(/(href|HREF)\=["|']/);for(var aW=0;aW<aZ.companions.length;aW++){var aY=aZ.companions[aW];if(aY.height==L&&aY.width==av&&aY.resource){var aU=aY.resource;if(aX.test(aU)){aU=aY.resource.match(/(href|HREF)\=["|']([^",^']+)["|']/)[2]}S=decodeURIComponent(aU).test(aV)?decodeURIComponent(aU).match(aV)[1]:0;break}}}catch(a0){r.record(a0,"error setting creative id")}}},a=function(){var aV=null;if(U&&U.resource){var aU=new RegExp(/<img.*?src\=\"(.*?)\"/);if(U.resource.test(aU)){aV=U.resource.match(aU)[1]}}return aV},M=function(){var aV=null;if(U&&U.resource){var aU=new RegExp(/adurl\=https?:\/\/www.tripadvisor.com\/(.*?)\"/);if(U.resource.test(aU)){aV=decodeURIComponent(decodeURIComponent(U.resource.match(aU)[1]))}}return aV},at=function(aW){U=null;if(aW&&aW.companions){try{for(var aU=0;aU<aW.companions.length;aU++){var aV=aW.companions[aU];if(aV.width==aN){U=aV;break}}}catch(aX){r.record(aX,"error retrieving logo companion")}}return !!U},e=function(aV,aW){if(!at(aW)){return}x(aW);aQ=Date.now();aK(J,false);az("#"+au).addClass("videoReady").show();aH();az(window).on("resize",A);q();aG.on("photoLightBoxHidden",T);var aU=aj();z(ar,aU,0,false);if(v.isTabletAlbumViewer()){az(aD).off("touchstart",g)}},ai=function(){var aU=az(aI);var aV=az('<div class="sprVidLayer sprVidAudio"></div>').text(W);aV.click(function(){h(aV)});az('<img class="sprVidAudioIcon">').prop("src","/img2/x.gif").appendTo(aV);var aW=az('<div class="videoPlayer"></div>');az("<div></div>").prop({"class":"jwPlayer",id:aA}).appendTo(aW);az("<div></div>").prop({id:au}).append(aV,aW).appendTo(aU)},c=function(){var aU=az("#SPONSORED_VIDEO .jwPlayer");var aV=az("#SPONSORED_VIDEO .videoPlayer");if(!aU.length||!aV.length){throw new Error("Player objects not defined.")}if(!ao.media||!ao.media.JWPlayer){throw new Error("JwPlayer is not loaded.")}var aW=n();aV.css("top",aW.t+"px");aV.show();am=ao.media.JWPlayer.createPlayer({containerId:aA,playerHeight:aW.h,playerWidth:aW.w,autostart:true,mute:true,videoUrl:V,previewUrl:aM,mediaId:ac,locationId:p,videoFormats:aS,isLocationPhotoAlbum:true,initFailureCallback:af,setupErrorCallback:af,sponsoredVideo:true,adMessageText:F.retrieve("sponsoredVideo.localize.remainingContentSecs"),disableSkipAd:true,disableAds:F.retrieve("ads.isSponsoredGeo")===true})},aK=function(aV,aU){az(aV).toggle(aU)},af=function(){C("player failure");r.record(null,"sponsored video: player initialization falure")},g=function(){if(am){var aU=am.getPlayer();aU.play()}},G=function(aU){if(aU&&!H){H=true;E==aU.slot.getSlotId().getDomId();if(aU.creativeId&&aU.creativeId!=u){ae=true}}},s=function(){if(document.getElementById(E)){window.googletag=window.googletag||{};googletag.cmd=googletag.cmd||[];googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",G)});var aU="#"+E;ao&&ao.common&&ao.common.ads&&ao.common.ads.injectAjaxAds("locationphotoalbum",aU,false)}else{r.record(null,"sponsored video 4x4 ad target not found, sponsored video skipped")}},ah=function(){if(!w){Y++;if(!o&&Y===D){o=true;s()}if(Y===O[1]){ao&&ao.common&&ao.common.ads&&ao.common.ads.injectAjaxAds("locationphotoalbum","#gpt-ad-4x4-b-locationphotoalbum",false)}if(aa.indexOf(Y)>-1&&v.isTabletAlbumViewer()){b.play();az(aD).on("touchstart",g)}if(!v.isTabletAlbumViewer()&&O.indexOf(Y)>-1){b.play()}}},Q=function(){al("navArrows");az(".heroWrapper .heroPhoto a.heroNav").removeClass("hidden")},aO=function(){al("thumbnailClick")},B=function(){al("skiplink")},ag=function(){al("preroll complete")},i=function(){C("no preroll")},T=function(){aG.off("galThumbClick",ah);aG.off("galNavClick",ah);var aU=w?"lightbox_close":false;if(aU){al(aU)}else{C()}},al=function(aW){var aV=false;if(w&&aQ!==null){var aU=aL()+"ms";z("time",aU,0,false);aV=true}C(aW,aV)},C=function(aV,aW){aW=aW||false;if(aV){z("unload",aV,aL(),false)}w=false;aQ=null;az(window).off("videoPlayer_preroll_companions_found",e);az(window).off("videoPlayer_preroll_end",ag);az(window).off("videoPlayer_complete",i);aG.off("photoLightBoxHidden",T);az(window).off("resize",A);if(am){try{var aU=am.getPlayer();if(aU&&typeof aU.getState==="function"){if(aU.getState()==="IDLE"){aU.play()}aU.pause(true);aU.stop()}}catch(aX){r.record(aX,"sponsored video: unable to cleanly unload")}}az("#"+au).remove();aK(J,true);if(f>=P){aG.off("galThumbClick",ah);aG.off("galNavClick",ah)}if(aW){az(K).empty();aG.fireEvent("mediaViewerCheckAdRefresh",true)}};var b={init:function(){Y=0;if(!ap){f=parseInt(aJ.getSessionKey("sponsoredVideoPlays"),10)||0;var aU=F.retrieve("photoAlbumSponsoredVideoCSS");if(!aU){r.record(null,"sponsored video cancelled: required CSS not found");C("missing required CSS");return}if(f<P){ay.load(aU,{forceType:"css"});aG.on("galThumbClick",ah);aG.on("galNavClick",ah)}ad=az(".heroWrapper .heroPhoto a.heroNav").height();ap=true}},play:function(){if(l()){if(!ae&&!F.has("sponsoredVideo.controlLogging")){C("no preroll available");return}if(f<P){f++;aJ.setSessionKey("sponsoredVideoPlays",f);if(F.has("sponsoredVideo.controlLogging")){var aU=aj();an.trackEventOnPage("pa_spr_vid_control",ar,aU,0,false);return}w=true;try{ai();c()}catch(aV){C("load error");r.record(aV,"sponsored video: unable to inject markup and initialize player")}az(window).on("videoPlayer_preroll_companions_found",e);az(window).on("videoPlayer_preroll_end",ag);az(window).on("videoPlayer_complete",i)}else{C()}}else{C("unsupported context")}}};aq.exportTo(b,"ta.photos.sponsoredVideo");return b});